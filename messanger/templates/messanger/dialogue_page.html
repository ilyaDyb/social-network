{% extends "base.html" %}
{% load static %}
{% block title %}Messanger{% endblock title %}
{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .input-group {
        display: flex;
        align-items: center;
    }
    
    textarea {
        resize: none;
    }
    
    .modal-body {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .modal-content {
        max-width: 500px;
        margin: auto;
    }
    .message {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .message.text-right {
        align-items: flex-end;
    }
    
    .message-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }
</style>
{% endblock styles %}
{% block content %}
<div class="container mt-3">
    <div class="row">
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-center">
                        <a href="{% url "users:profile" user_sender.username %}">
                            <img style="border-radius: 50%;" src="{{ user_sender.avatar.url }}" alt="" width="52" height="52">
                        </a>
                        <div class="ml-3">
                            <h5 class="mb-1"><a style="text-decoration:none; color: black;" href="{% url "users:profile" user_sender.username %}">
                                {{ user_sender.first_name }} {{ user_sender.last_name }}</a></h5>
                            <p class="mb-1" style="margin-bottom: 0;">{% if not user_activity.is_online %} Last seen {{ user_activity.get_last_activity }}.. {% else %}Online{% endif %}</p>
                        </div>

                    </div>
                </div>
                <div class="card-body" id="chat-messages" style="height: 750px; overflow-y: auto;">
                    <!-- Сообщения чата -->
                    {% if not messages %}
                    <div class="d-flex justify-content-center" style="margin-top: 50%;">
                        <h3>Write him right now)</h3>
                    </div>
                    {% else %}
                        {% for message in messages %}
                            {% if message.sender == user_receiver %}
                                <div class="media mb-3 d-flex justify-content-end">
                                    <div class="media-body text-right">
                                        <div class="message bg-primary text-white p-2 rounded" style="max-width: 580px;">
                                            {{ message.content }}
                                            <small style="background-color: #9966cc;" class="text-dark">{{ message.get_timestamp }}</small>
                                            {% if message.file %}
                                                <img src="{{ message.file.url }}" alt="" class="message-image mt-2">
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="media mb-3 d-flex">
                                    <div class="media-body">
                                        <div class="message bg-light p-2 rounded" style="max-width: 580px;">
                                            {{ message.content }}
                                            <small style="background-color: #9966cc;" class="text-dark">{{ message.get_timestamp }}</small>
                                            {% if message.file %}
                                                <img src="{{ message.file.url }}" alt="" class="message-image mt-2">
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <input id="chat-message-input" type="text" size="100">
                <button id="chat-message-submit">Send</button>
                <button id="upload-photo-btn">Upload Photo</button>
                <input id="photo-input" type="file" style="display:none;">
                {% comment %} <div class="card-footer">
                    <form id="message-form" method="post" action="{% url 'messanger:dialogue' user_sender.username %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="input-group">
                            <textarea name="message" class="form-control" placeholder="Type your message here..." rows="1" style="resize: none;"></textarea>
                            <input type="file" name="photo" accept="image/*" class="d-none" id="photo-input">
                            <div class="input-group-append">
                                <button class="btn btn-secondary" type="button" id="upload-photo-btn">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="btn btn-primary" type="submit">Send</button>
                            </div>
                        </div>
                    </form>
                </div> {% endcomment %}
            </div>
        </div>
        <div class="col-md-3">
            <div class="rounded-5" style="height: auto;">
                <div class="list-group">
                    <form action="" method="get">
                        <a href="" class="list-group-item list-group-item-action">All chats</a>
                        <a href="" class="list-group-item list-group-item-action">Unread</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" name="chatId" id="chatId" value="{{ chat_id }}">
<input type="hidden" name="user_receiver" id="user_receiver_id" value="{{ user_receiver.id }}">
{% endblock content %}
{% block scripts %}
<script>

    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('upload-photo-btn').addEventListener('click', function() {
            document.getElementById('photo-input').click();
        });
        const chatBlock = document.getElementById("chat-messages");
        chatBlock.scrollTop = chatBlock.scrollHeight;

        const chatId = "{{ chat_id }}";
        const userId = "{{ user_receiver.id }}";
        const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + chatId + "/");

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const messageElement = document.createElement('div');
            messageElement.className = "media mb-3 d-flex";
            if (data.username === "{{ user_receiver.username }}") {
                messageElement.className += " justify-content-end";
                messageElement.innerHTML = `
                    <div class="media-body text-right">
                        <div class="message bg-primary text-white p-2 rounded" style="max-width: 580px;">
                            ${data.message}
                            <small style="background-color: #9966cc;" class="text-dark">Just now</small>
                            ${data.file_url ? `<img src="${data.file_url}" alt="" class="message-image mt-2">` : ''}
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="media-body">
                        <div class="message bg-light p-2 rounded" style="max-width: 580px;">
                            ${data.message}
                            <small style="background-color: #9966cc;" class="text-dark">Just now</small>
                            ${data.file_url ? `<img src="${data.file_url}" alt="" class="message-image mt-2">` : ''}
                        </div>
                    </div>
                `;
            }
            document.getElementById('chat-messages').appendChild(messageElement);
        };

        document.getElementById('chat-message-submit').onclick = function() {
            const messageInput = document.getElementById('chat-message-input');
            const message = messageInput.value;
            socket.send(JSON.stringify({
                'message': message,
                'user_id': userId,
                'chat_id': chatId,
            }));
            messageInput.value = '';
        };

        document.getElementById('upload-photo-btn').onclick = function() {
            document.getElementById('photo-input').click();
        };

        document.getElementById('photo-input').onchange = function(event) {
            const formData = new FormData();
            formData.append('photo', event.target.files[0]);
            formData.append('user_id', userId);
            formData.append('chat_id', chatId);
            fetch('/messanger/upload/', {
                method: 'POST',
                body: formData,
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    socket.send(JSON.stringify({
                        'message': '',
                        'user_id': userId,
                        'chat_id': chatId,
                        'file_url': data.url,
                    }));
                }
            });
        };
    });

</script>
{% endblock scripts %}